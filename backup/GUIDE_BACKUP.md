# üõ°Ô∏è Guide Complet de Sauvegarde - MindEase AI

## üìë Table des Mati√®res
1. [Vue d'ensemble](#vue-densemble)
2. [Sauvegarde Automatique Quotidienne](#sauvegarde-automatique-quotidienne)
3. [Sauvegarde Manuelle](#sauvegarde-manuelle)
4. [Restauration](#restauration)
5. [Maintenance et Monitoring](#maintenance-et-monitoring)
6. [D√©pannage](#d√©pannage)

---

## üéØ Vue d'ensemble

Ce guide vous explique comment sauvegarder et restaurer compl√®tement votre application MindEase AI, incluant :
- **Base de donn√©es Supabase** (sch√©ma + donn√©es)
- **Code source critique** (services, types, contextes)
- **Configuration** (variables d'environnement, packages)
- **Assets et styles** (CSS, images)

### üìÅ Structure des Backups

```
backup/
‚îú‚îÄ‚îÄ automated/          # Sauvegardes automatiques
‚îú‚îÄ‚îÄ manual/             # Sauvegardes manuelles
‚îú‚îÄ‚îÄ scripts/            # Scripts de sauvegarde/restauration
‚îî‚îÄ‚îÄ GUIDE_BACKUP.md     # Ce guide
```

---

## üîÑ Sauvegarde Automatique Quotidienne

### üöÄ Configuration Initiale

#### 1. V√©rifier les Scripts

```bash
# V√©rifier que les scripts sont ex√©cutables
ls -la backup/scripts/
# Doit afficher : -rwxr-xr-x pour les fichiers .sh
```

#### 2. Tester la Sauvegarde Manuelle

```bash
# Ex√©cuter une sauvegarde de test
./backup/scripts/backup-database.sh
```

#### 3. Configurer Cron pour Automatisation

```bash
# Ouvrir la crontab
crontab -e

# Ajouter cette ligne pour une sauvegarde quotidienne √† 2h00
0 2 * * * /home/assyin/MindEase-IA/backup/scripts/auto-backup-cron.sh

# Ou pour une sauvegarde toutes les 6 heures
0 */6 * * * /home/assyin/MindEase-IA/backup/scripts/auto-backup-cron.sh

# Ou pour une sauvegarde hebdomadaire (dimanche √† 3h00)
0 3 * * 0 /home/assyin/MindEase-IA/backup/scripts/auto-backup-cron.sh
```

#### 4. V√©rifier la Configuration Cron

```bash
# Lister les t√¢ches cron actuelles
crontab -l

# V√©rifier les logs cron du syst√®me
tail -f /var/log/cron
# ou sur Ubuntu/Debian :
tail -f /var/log/syslog | grep CRON
```

### üìä Monitoring des Sauvegardes Automatiques

#### V√©rifier les Logs

```bash
# Voir les logs de sauvegarde automatique
tail -f backup/automated/backup-cron.log

# Voir les 20 derni√®res lignes
tail -20 backup/automated/backup-cron.log
```

#### Lister les Backups R√©cents

```bash
# Voir les sauvegardes des 7 derniers jours
find backup/automated/ -name "*.tar.gz" -mtime -7 -ls

# Voir la taille des backups
du -sh backup/automated/*.tar.gz | tail -5
```

---

## üîß Sauvegarde Manuelle

### üìã M√©thode 1 : Script Automatis√© (Recommand√©)

```bash
# Sauvegarde compl√®te en une commande
./backup/scripts/backup-database.sh
```

**Ce script sauvegarde automatiquement :**
- ‚úÖ Sch√©ma de base de donn√©es
- ‚úÖ Configuration (.env, package.json, etc.)
- ‚úÖ Code source critique (services, types, contextes)
- ‚úÖ M√©tadonn√©es de sauvegarde
- ‚úÖ Compression automatique
- ‚úÖ Nettoyage des anciens backups

### üìù M√©thode 2 : Sauvegarde Manuelle D√©taill√©e

Suivez la checklist compl√®te : [manual-backup-checklist.md](manual/manual-backup-checklist.md)

### üéØ Sauvegarde Rapide d'Urgence

```bash
# Sauvegarde ultra-rapide des √©l√©ments essentiels
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p backup/emergency/emergency-$DATE

# Configuration critique
cp .env backup/emergency/emergency-$DATE/
cp supabase-schema.sql backup/emergency/emergency-$DATE/

# Code source essentiel
cp -r src/services backup/emergency/emergency-$DATE/
cp -r src/types backup/emergency/emergency-$DATE/

# Compresser
tar -czf backup/emergency/emergency-$DATE.tar.gz backup/emergency/emergency-$DATE
rm -rf backup/emergency/emergency-$DATE

echo "‚úÖ Sauvegarde d'urgence: backup/emergency/emergency-$DATE.tar.gz"
```

---

## üîÑ Restauration

### üöÄ Restauration Automatique

```bash
# Lister les backups disponibles
ls -la backup/automated/*.tar.gz

# Restaurer un backup sp√©cifique
./backup/scripts/restore-backup.sh mindease_db_backup_20241228_143022.tar.gz

# Restauration forc√©e (sans confirmation)
./backup/scripts/restore-backup.sh mindease_db_backup_20241228_143022.tar.gz --force
```

### üìù √âtapes de Restauration Manuelle

#### 1. Pr√©paration

```bash
# Arr√™ter l'application
pkill -f "vite"
pkill -f "npm.*dev"

# Cr√©er un backup de s√©curit√© de l'√©tat actuel
cp .env .env.backup-$(date +%Y%m%d)
cp -r src/services src/services.backup-$(date +%Y%m%d)
```

#### 2. Extraction du Backup

```bash
# Extraire le backup
cd /tmp
tar -xzf /home/assyin/MindEase-IA/backup/automated/BACKUP_FILE.tar.gz
```

#### 3. Restauration des Fichiers

```bash
# Retourner au r√©pertoire du projet
cd /home/assyin/MindEase-IA

# Restaurer la configuration
cp /tmp/EXTRACTED_BACKUP_FOLDER/.env .env

# Restaurer le code source
cp -r /tmp/EXTRACTED_BACKUP_FOLDER/src/services src/
cp -r /tmp/EXTRACTED_BACKUP_FOLDER/src/types src/
cp -r /tmp/EXTRACTED_BACKUP_FOLDER/src/contexts src/

# Restaurer les packages
cp /tmp/EXTRACTED_BACKUP_FOLDER/package.json .
npm install
```

#### 4. Restauration de la Base de Donn√©es

```bash
# Le sch√©ma est restaur√© dans : restored-schema.sql
# Vous devez l'appliquer manuellement dans Supabase :

# 1. Ouvrir Supabase Dashboard
# 2. Aller dans SQL Editor
# 3. Copier le contenu de restored-schema.sql
# 4. Ex√©cuter les requ√™tes
```

#### 5. V√©rification Post-Restauration

```bash
# V√©rifier les variables d'environnement
cat .env | grep -E "VITE_SUPABASE|VITE_GOOGLE"

# R√©installer les d√©pendances
npm install

# Tester l'application
npm run dev
```

### üîç V√©rification de la Restauration

#### Tests √† Effectuer

1. **D√©marrage de l'application**
   ```bash
   npm run dev
   # V√©rifier : http://localhost:5173
   ```

2. **Connectivit√© Supabase**
   - V√©rifier les connexions dans les logs de la console
   - Tester la cr√©ation d'une conversation
   - Tester l'envoi d'un message

3. **Fonctionnalit√©s IA**
   - Tester la reconnaissance vocale
   - V√©rifier les r√©ponses Gemini
   - Contr√¥ler les contextes AI

4. **Interface utilisateur**
   - V√©rifier les composants principaux
   - Tester le changement de langue
   - Contr√¥ler les styles CSS

---

## üîß Maintenance et Monitoring

### üìä Surveillance des Backups

#### Script de Monitoring

```bash
#!/bin/bash
# backup/scripts/monitor-backups.sh

BACKUP_DIR="/home/assyin/MindEase-IA/backup/automated"
MAX_AGE_DAYS=1  # Alerte si aucun backup depuis 1 jour

# Trouver le backup le plus r√©cent
LATEST_BACKUP=$(find "$BACKUP_DIR" -name "*.tar.gz" -type f -printf '%T@ %p\n' | sort -nr | head -1 | cut -d' ' -f2-)

if [ -z "$LATEST_BACKUP" ]; then
    echo "‚ùå ALERTE: Aucun backup trouv√©!"
    exit 1
fi

# V√©rifier l'√¢ge du dernier backup
LATEST_TIME=$(stat -c %Y "$LATEST_BACKUP")
CURRENT_TIME=$(date +%s)
AGE_HOURS=$(( (CURRENT_TIME - LATEST_TIME) / 3600 ))

if [ $AGE_HOURS -gt 24 ]; then
    echo "‚ö†Ô∏è  ALERTE: Dernier backup datant de $AGE_HOURS heures"
else
    echo "‚úÖ Backup r√©cent trouv√© (il y a $AGE_HOURS heures)"
fi

# V√©rifier l'espace disque
DISK_USAGE=$(df "$BACKUP_DIR" | tail -1 | awk '{print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 85 ]; then
    echo "‚ö†Ô∏è  ALERTE: Espace disque faible ($DISK_USAGE% utilis√©)"
fi

# Lister les 5 derniers backups
echo "üìÅ Derniers backups:"
ls -laht "$BACKUP_DIR"/*.tar.gz | head -5
```

#### Cr√©er une Alerte Email (Optionnel)

```bash
# backup/scripts/backup-alert.sh
#!/bin/bash

EMAIL="votre-email@example.com"
MONITOR_OUTPUT=$(./backup/scripts/monitor-backups.sh)

# Envoyer un email si des alertes sont d√©tect√©es
if echo "$MONITOR_OUTPUT" | grep -q "ALERTE"; then
    echo "$MONITOR_OUTPUT" | mail -s "üö® Alerte Backup MindEase AI" "$EMAIL"
fi
```

### üßπ Nettoyage Automatique

```bash
# backup/scripts/cleanup-old-backups.sh
#!/bin/bash

BACKUP_DIR="/home/assyin/MindEase-IA/backup/automated"
KEEP_DAYS=30  # Garder 30 jours
KEEP_COUNT=10  # Garder au moins 10 backups

echo "üßπ Nettoyage des anciens backups..."

# Supprimer les backups plus anciens que KEEP_DAYS jours
find "$BACKUP_DIR" -name "*.tar.gz" -type f -mtime +$KEEP_DAYS -delete

# S'assurer qu'on garde au moins KEEP_COUNT backups
BACKUP_COUNT=$(ls "$BACKUP_DIR"/*.tar.gz 2>/dev/null | wc -l)
if [ "$BACKUP_COUNT" -lt "$KEEP_COUNT" ]; then
    echo "‚úÖ Conservation de tous les backups ($BACKUP_COUNT < $KEEP_COUNT)"
else
    # Supprimer les plus anciens au-del√† de KEEP_COUNT
    ls -t "$BACKUP_DIR"/*.tar.gz | tail -n +$((KEEP_COUNT + 1)) | xargs -r rm
    echo "‚úÖ Nettoyage termin√©, $KEEP_COUNT backups conserv√©s"
fi
```

### üìà Statistiques de Sauvegarde

```bash
# backup/scripts/backup-stats.sh
#!/bin/bash

BACKUP_DIR="/home/assyin/MindEase-IA/backup/automated"

echo "üìä STATISTIQUES DE SAUVEGARDE"
echo "================================"

# Nombre total de backups
TOTAL_BACKUPS=$(ls "$BACKUP_DIR"/*.tar.gz 2>/dev/null | wc -l)
echo "Nombre total de backups: $TOTAL_BACKUPS"

# Taille totale
TOTAL_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
echo "Taille totale: $TOTAL_SIZE"

# Taille moyenne
if [ "$TOTAL_BACKUPS" -gt 0 ]; then
    TOTAL_KB=$(du -sk "$BACKUP_DIR"/*.tar.gz | awk '{sum+=$1} END {print sum}')
    AVG_KB=$((TOTAL_KB / TOTAL_BACKUPS))
    echo "Taille moyenne: $((AVG_KB / 1024)) MB"
fi

# Dernier backup
LATEST=$(ls -t "$BACKUP_DIR"/*.tar.gz 2>/dev/null | head -1)
if [ -n "$LATEST" ]; then
    LATEST_DATE=$(stat -c %y "$LATEST" | cut -d' ' -f1,2)
    LATEST_SIZE=$(du -sh "$LATEST" | cut -f1)
    echo "Dernier backup: $(basename "$LATEST") ($LATEST_SIZE) - $LATEST_DATE"
fi

echo "================================"
```

---

## üîß D√©pannage

### ‚ùå Probl√®mes Courants

#### 1. Script de Sauvegarde ne Fonctionne Pas

```bash
# V√©rifier les permissions
ls -la backup/scripts/backup-database.sh
# Doit afficher: -rwxr-xr-x

# Rendre ex√©cutable si n√©cessaire
chmod +x backup/scripts/*.sh
```

#### 2. Erreur "Espace Disque Insuffisant"

```bash
# V√©rifier l'espace disponible
df -h /home/assyin/MindEase-IA/backup

# Nettoyer les anciens backups
./backup/scripts/cleanup-old-backups.sh

# Ou suppression manuelle
rm backup/automated/mindease_db_backup_OLDEST_*.tar.gz
```

#### 3. Cron ne s'Ex√©cute Pas

```bash
# V√©rifier le service cron
sudo service cron status

# D√©marrer cron si n√©cessaire
sudo service cron start

# V√©rifier les logs cron
tail -f /var/log/syslog | grep CRON

# Tester la crontab
crontab -l
```

#### 4. Erreur de Restauration

```bash
# V√©rifier l'int√©grit√© du backup
tar -tzf backup/automated/BACKUP_FILE.tar.gz > /dev/null
# Si √ßa √©choue, le fichier est corrompu

# Utiliser un backup pr√©c√©dent
ls -laht backup/automated/*.tar.gz
```

#### 5. Variables d'Environnement Manquantes

```bash
# V√©rifier le fichier .env restaur√©
cat .env

# Comparer avec un backup connu
diff .env .env.backup-YYYYMMDD

# Restaurer manuellement les variables manquantes
```

### üîç Logs de D√©bogage

```bash
# Logs de sauvegarde automatique
tail -f backup/automated/backup-cron.log

# Logs de l'application
npm run dev 2>&1 | tee debug.log

# Logs du syst√®me
journalctl -f
```

### üìû Support d'Urgence

En cas de probl√®me critique :

1. **Arr√™ter imm√©diatement** toute modification
2. **Cr√©er un backup d'urgence** de l'√©tat actuel
3. **Documenter** le probl√®me rencontr√©
4. **Utiliser le backup le plus r√©cent** fonctionnel
5. **Tester minutieusement** apr√®s restauration

---

## üìö Ressources Suppl√©mentaires

- **Scripts de sauvegarde** : `/backup/scripts/`
- **Checklist manuelle** : `/backup/manual/manual-backup-checklist.md`
- **Logs automatiques** : `/backup/automated/backup-cron.log`

---

## ‚ö° Commandes de R√©f√©rence Rapide

```bash
# Sauvegarde manuelle imm√©diate
./backup/scripts/backup-database.sh

# Restauration
./backup/scripts/restore-backup.sh BACKUP_FILE.tar.gz

# Monitoring
./backup/scripts/monitor-backups.sh

# Statistiques
./backup/scripts/backup-stats.sh

# Nettoyage
./backup/scripts/cleanup-old-backups.sh

# Configuration cron quotidienne
echo "0 2 * * * $(pwd)/backup/scripts/auto-backup-cron.sh" | crontab -
```

---

**üõ°Ô∏è Votre syst√®me MindEase AI est maintenant prot√©g√© par un syst√®me de sauvegarde complet !**